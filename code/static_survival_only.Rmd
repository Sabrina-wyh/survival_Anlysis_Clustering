---
title: "survival analysis"
author: "Yihan Wang"
date: "2025-01-04"
output: word_document
---

```{r}
rm(list = ls())
```

```{r}
library(survival)
library(randomForestSRC)
library(broom)
library(ggplot2)
library(dplyr)
library(caret)
library(pROC)
library(mRMRe)
library(kml)
library(rgl)
library(longitudinalData)
library(doParallel)
library(foreach)
library(dtw)
library(cluster)  
library(factoextra)
library(parallel)
library(survival)
library(timeROC)
library(dplyr)
```


############ Time-Varying Cox Model ###############

######## internal validation ##########
APOE4 + Age only
```{r}

  
  

```

```{r}
# 3-Fold Cross-Validation Function with Multiple Iterations and High Correlation Handling
do_internal_cv_time_varying_cox <- function(data, folds = 3, iterations = 10) {
  
  # Extract predictors
  predictors <- setdiff(names(data), c("start", "stop", "event", "ID"))

  # Calculate correlation matrix and remove highly correlated pairs (>0.9)
  corr_matrix <- cor(data[predictors], use = "pairwise.complete.obs")
  high_corr_pairs <- which(abs(corr_matrix) > 0.9, arr.ind = TRUE)
  high_corr_pairs <- high_corr_pairs[high_corr_pairs[, 1] < high_corr_pairs[, 2], ]
  correlated_vars <- unique(c(rownames(high_corr_pairs), colnames(high_corr_pairs)))
  filtered_predictors <- setdiff(predictors, correlated_vars)

  formula <- as.formula(paste("Surv(start, stop, event) ~", paste(filtered_predictors, collapse = " + ")))

  # Initialize storage for results
  all_c_index_list <- list()
  all_auc_results <- list()

  for (iter in 1:iterations) {
    set.seed(iter)
    
    # Split data into folds based on ID
    unique_ids <- unique(data$ID)
    fold_assignments <- sample(rep(1:folds, length.out = length(unique_ids)))
    names(fold_assignments) <- unique_ids
    c_index_list <- list()
    auc_results <- list()

    for (fold in 1:folds) {
      train_ids <- unique_ids[fold_assignments != fold]
      test_ids <- unique_ids[fold_assignments == fold]
      train_data <- data[data$ID %in% train_ids, ]
      test_data <- data[data$ID %in% test_ids, ]

      # Fit Cox proportional hazards model
      cox_model <- coxph(formula, data = train_data, id = train_data$ID, ties = "efron")
      risk_scores <- predict(cox_model, newdata = test_data, type = "risk")

      # Compute C-index
      c_index <- concordance(cox_model, newdata = test_data)$concordance
      c_index_list[[fold]] <- c_index

      # Compute AUC for specified time points
      times <- unique(test_data$stop)
      times <- as.numeric(times)
      times <- times[!is.na(times) & times > 0]  # Remove NA and non-positive times

      auc_result <- timeROC(
        T = test_data$stop,
        delta = test_data$event,
        marker = risk_scores,
        cause = 1,
        times = times
      )
      auc_results[[fold]] <- auc_result
    }

    all_c_index_list[[iter]] <- c_index_list
    all_auc_results[[iter]] <- do.call(rbind, lapply(1:folds, function(fold) {
      data.frame(
        Iteration = iter,
        Fold = fold,
        Time = auc_results[[fold]]$times,
        AUC = auc_results[[fold]]$AUC
      )
    }))
  }

  auc_summary <- do.call(rbind, all_auc_results)
  auc_stats <- auc_summary %>%
    group_by(Time) %>%
    summarise(
      Median_AUC = median(AUC, na.rm = TRUE),
      Q1_AUC = quantile(AUC, 0.25, na.rm = TRUE),
      Q3_AUC = quantile(AUC, 0.75, na.rm = TRUE)
    )

  # Compute overall statistics for C-index
  all_c_indexes <- unlist(all_c_index_list)
  overall_c_median <- median(all_c_indexes, na.rm = TRUE)
  c_Q1 <- quantile(all_c_indexes, 0.25, na.rm = TRUE)
  c_Q3 <- quantile(all_c_indexes, 0.75, na.rm = TRUE)

  cat("Overall C-index Median:", overall_c_median, "\n")
  cat("C-index 25th Percentile (Q1):", c_Q1, "\n")
  cat("C-index 75th Percentile (Q3):", c_Q3, "\n\n")

  return(list(
    C_Index_List = all_c_index_list,
    AUC_Stats = auc_stats
  ))
}
```


```{r}
external_validation_time_varying_cox <- function(train_data, test_data) {
  
  # Extract predictors
  predictors <- setdiff(names(train_data), c("start", "stop", "event", "ID"))

  # Calculate correlation matrix and remove highly correlated pairs (>0.9)
  corr_matrix <- cor(train_data[predictors], use = "pairwise.complete.obs")
  high_corr_pairs <- which(abs(corr_matrix) > 0.9, arr.ind = TRUE)
  high_corr_pairs <- high_corr_pairs[high_corr_pairs[, 1] < high_corr_pairs[, 2], ]
  correlated_vars <- unique(c(rownames(high_corr_pairs), colnames(high_corr_pairs)))
  filtered_predictors <- setdiff(predictors, correlated_vars)

  formula <- as.formula(paste("Surv(start, stop, event) ~", paste(filtered_predictors, collapse = " + ")))

  # Fit Cox proportional hazards model
  cox_model <- coxph(formula, data = train_data, id = train_data$ID, ties = "efron")
  print(summary(cox_model))
  # Calculate risk scores for the test set
  risk_scores <- predict(cox_model, newdata = test_data, type = "risk")

  # Compute C-index
  c_index <- concordance(cox_model, newdata = test_data)$concordance

  # Compute AUC for specified time points
  times <- unique(test_data$stop)
  times <- as.numeric(times)
  times <- times[!is.na(times) & times > 0]  # Remove NA and non-positive times

  auc_result <- timeROC(
    T = test_data$stop,
    delta = test_data$event,
    marker = risk_scores,
    cause = 1,
    times = times
  )

  # Prepare AUC summary statistics
  auc_summary <- data.frame(
    Time = auc_result$times,
    AUC = auc_result$AUC
  )


  # Print results
  cat("C-index:", c_index, "\n")
  print(auc_result)
  

  # Return results
  return(list(
    C_Index = c_index,
    AUC_Stats = auc_summary
  ))
}

```

# Full Model
```{r}
NACC_full_df <- read.csv("preprocessed_data/longitudinal_NACC_full_Jan12.csv")
AIBL_full_df <- read.csv("preprocessed_data/longitudinal_AIBL_full_Jan12.csv")

Cog_fts = c("CDR_SB", "GDS", "MMSE", "memory_recall1", "memory_recall2", "Digit_Span_F", "Digit_Span_B", "animal", "BNT")
demo_fts = c("age", "sex", "edu","BMI")
basic_fts = c("APOE4", "age")
index_feature = c("start", "stop", "event", "ID")
```

## APOE4 + age
```{r}
time_varying_APOE4_NACC_full_results <- do_internal_cv_time_varying_cox(NACC_full_df[, unique(c(basic_fts, index_feature))])
print(time_varying_APOE4_NACC_full_results$AUC_Stats)
```

```{r}
time_varying_APOE4_AIBL_full_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(basic_fts, index_feature))])
print(time_varying_APOE4_AIBL_full_results$AUC_Stats)
```

```{r}
time_varying_APOE4_full_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(basic_fts, index_feature))], AIBL_full_df[, unique(c(basic_fts, index_feature))])
```


## Cog
```{r}
time_varying_cog_NACC_full_results <- do_internal_cv_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, index_feature))])
print(time_varying_cog_NACC_full_results$AUC_Stats)
```

```{r}
time_varying_cog_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(Cog_fts, index_feature))])
print(time_varying_cog_AIBL_results$AUC_Stats)
```

```{r}
time_varying_cog_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, index_feature))], AIBL_full_df[, unique(c(Cog_fts, index_feature))])
```
## all Feature
```{r}
time_varying_all_NACC_results <- do_internal_cv_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
print(time_varying_all_NACC_results$AUC_Stats)
```

```{r}
time_varying_all_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
print(time_varying_all_AIBL_results$AUC_Stats)
```

```{r}
time_varying_cog_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))], AIBL_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
```

# HC
```{r}
NACC_HC_df <- read.csv("preprocessed_data/longitudinal_NACC_HC_Jan12.csv")
AIBL_HC_df <- read.csv("preprocessed_data/longitudinal_AIBL_HC_Jan12.csv")

Cog_fts = c("CDR_SB", "GDS", "MMSE", "memory_recall1", "memory_recall2", "Digit_Span_F", "Digit_Span_B", "animal", "BNT")
demo_fts = c("age", "sex", "edu","BMI")
basic_fts = c("APOE4", "age")
index_feature = c("start", "stop", "event", "ID")
```

## APOE4 + age
```{r}
time_varying_APOE4_NACC_results <- do_internal_cv_time_varying_cox(NACC_full_df[, unique(c(basic_fts, index_feature))])
print(time_varying_APOE4_NACC_results$AUC_Stats)
```

```{r}
time_varying_APOE4_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(basic_fts, index_feature))])
print(time_varying_APOE4_AIBL_results$AUC_Stats)
```

```{r}
time_varying_APOE4_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(basic_fts, index_feature))], AIBL_full_df[, unique(c(basic_fts, index_feature))])
```


## Cog
```{r}
time_varying_cog_NACC_results <- do_internal_cv_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, index_feature))])
print(time_varying_cog_NACC_results$AUC_Stats)
```

```{r}
time_varying_cog_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(Cog_fts, index_feature))])
print(time_varying_cog_AIBL_results$AUC_Stats)
```

```{r}
time_varying_cog_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, index_feature))], AIBL_full_df[, unique(c(Cog_fts, index_feature))])
```
## all Feature
```{r}
time_varying_all_NACC_results <- do_internal_cv_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
print(time_varying_all_NACC_results$AUC_Stats)
```

```{r}
time_varying_all_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
print(time_varying_all_AIBL_results$AUC_Stats)
```

```{r}
time_varying_cog_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))], AIBL_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
```


# MCI
```{r}
NACC_full_df <- read.csv("preprocessed_data/longitudinal_NACC_full_Jan12.csv")
AIBL_full_df <- read.csv("preprocessed_data/longitudinal_AIBL_full_Jan12.csv")

```

## APOE4 + age
```{r}
time_varying_APOE4_NACC_results <- do_internal_cv_time_varying_cox(NACC_full_df[, unique(c(basic_fts, index_feature))])
print(time_varying_APOE4_NACC_results$AUC_Stats)
```

```{r}
time_varying_APOE4_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(basic_fts, index_feature))])
print(time_varying_APOE4_AIBL_results$AUC_Stats)
```

```{r}
time_varying_APOE4_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(basic_fts, index_feature))], AIBL_full_df[, unique(c(basic_fts, index_feature))])
```


## Cog
```{r}
time_varying_cog_NACC_results <- do_internal_cv_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, index_feature))])
print(time_varying_cog_NACC_results$AUC_Stats)
```

```{r}
time_varying_cog_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(Cog_fts, index_feature))])
print(time_varying_cog_AIBL_results$AUC_Stats)
```

```{r}
time_varying_cog_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, index_feature))], AIBL_full_df[, unique(c(Cog_fts, index_feature))])
```
## all Feature
```{r}
time_varying_all_NACC_results <- do_internal_cv_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
print(time_varying_all_NACC_results$AUC_Stats)
```

```{r}
time_varying_all_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
print(time_varying_all_AIBL_results$AUC_Stats)
```

```{r}
time_varying_cog_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))], AIBL_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
```




############# first 3 visits only #################
```{r}
NACC_full_3_visits_df <- read.csv("preprocessed_data/longitudinal_NACC_3_visits_full_Jan12.csv")
AIBL_full_3_visits_df <- read.csv("preprocessed_data/longitudinal_AIBL_3_visits_full_Jan12.csv")
```

## APOE4 + age
```{r}
time_varying_APOE4_NACC_full_3_results <- do_internal_cv_time_varying_cox(NACC_full_3_visits_df[, unique(c(basic_fts, index_feature))])
print(time_varying_APOE4_NACC_full_3_results$AUC_Stats)
```

```{r}
time_varying_APOE4_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(basic_fts, index_feature))])
print(time_varying_APOE4_AIBL_results$AUC_Stats)
```

```{r}
time_varying_APOE4_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(basic_fts, index_feature))], AIBL_full_df[, unique(c(basic_fts, index_feature))])
```


## Cog
```{r}
time_varying_cog_NACC_full_3_results <- do_internal_cv_time_varying_cox(NACC_full_3_visits_df[, unique(c(Cog_fts, index_feature))])
print(time_varying_cog_NACC_full_3_results$AUC_Stats)
```

```{r}
time_varying_cog_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(Cog_fts, index_feature))])
print(time_varying_cog_AIBL_results$AUC_Stats)
```

```{r}
time_varying_cog_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, index_feature))], AIBL_full_df[, unique(c(Cog_fts, index_feature))])
```
## all Feature
```{r}
time_varying_all_NACC_results <- do_internal_cv_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
print(time_varying_all_NACC_results$AUC_Stats)
```

```{r}
time_varying_all_AIBL_results <- do_internal_cv_time_varying_cox(AIBL_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
print(time_varying_all_AIBL_results$AUC_Stats)
```

```{r}
time_varying_cog_external_results <- external_validation_time_varying_cox(NACC_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))], AIBL_full_df[, unique(c(Cog_fts, demo_fts, basic_fts, index_feature))])
```















